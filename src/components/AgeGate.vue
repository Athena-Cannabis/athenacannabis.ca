<template>
  <div class="w-full md:min-h-screen flex justify-center items-center
              bg-white">
    <div class=" sm:w-3/4 md:w-3/5 lg:w-1/2 2xl:w-2/5 bg-white
                pt-20 px-8 md:p-12
                flex flex-col justify-center items-center
                md:border-2 md:border-gray-500 md:rounded-3xl">

      <div class="pb-5">
        <svg class="h-52" viewBox="0 0 130 108" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M64.8005 0C55.2485 0 47.5205 7.728 47.5205 17.28V43.2C47.5205 52.752 55.2485 60.48 64.8005 60.48C74.3525 60.48 82.0805 52.752 82.0805 43.2V17.28C82.0805 7.728 74.3525 0 64.8005 0ZM60.6965 45.36C59.4965 43.608 58.6325 41.52 58.4885 40.128C58.3685 38.952 58.5125 37.368 58.8245 35.568C58.9205 34.968 59.0645 34.344 59.1845 33.72C59.2565 33.408 59.3285 33.072 59.4005 32.76C59.5445 32.112 59.7125 31.44 59.9045 30.768C60.0005 30.432 60.0965 30.096 60.1685 29.76C60.3605 29.088 60.5525 28.416 60.7445 27.744C60.8405 27.408 60.9365 27.072 61.0565 26.736C61.2725 26.064 61.4645 25.416 61.6805 24.768C61.8485 24.264 61.9925 23.784 62.1605 23.304C62.2325 23.064 62.3045 22.848 62.4005 22.608C63.6725 18.84 64.7765 16.032 64.7765 16.032C64.7765 16.032 64.8485 16.224 64.9685 16.56C65.0165 16.704 65.0885 16.872 65.1605 17.064C65.1605 17.064 65.1605 17.064 65.1605 17.088C65.2085 17.232 65.2805 17.4 65.3525 17.568C65.5205 18.024 65.7125 18.552 65.9285 19.152C65.9525 19.2 65.9765 19.272 66.0005 19.344C66.3365 20.28 66.7205 21.408 67.1285 22.608C67.2005 22.824 67.2725 23.064 67.3685 23.304C67.5365 23.784 67.6805 24.264 67.8485 24.768C68.1605 25.728 68.4725 26.736 68.7845 27.744C68.9765 28.416 69.1925 29.088 69.3605 29.76C69.4565 30.096 69.5525 30.432 69.6245 30.768C69.7925 31.44 69.9605 32.112 70.1285 32.76C70.2005 33.096 70.2725 33.408 70.3445 33.72C70.4885 34.368 70.6085 34.992 70.7045 35.568C71.0165 37.368 71.1605 38.952 71.0405 40.128C70.8965 41.52 70.0325 43.608 68.8325 45.36C68.1365 46.392 67.3205 47.28 66.5045 47.856L64.7525 28.488L63.0005 47.856C62.4005 47.448 61.8245 46.872 61.2965 46.2C61.1045 45.936 60.9125 45.648 60.6965 45.36ZM79.3925 43.2C79.3925 50.328 74.2565 56.256 67.4885 57.528V50.424C71.0165 48.432 73.5125 43.056 73.7765 40.392C74.0885 37.368 73.1045 32.304 70.7525 24.888C69.0965 19.632 67.3685 15.216 67.2965 15.024L64.8005 8.616L62.3045 15.048C62.2325 15.24 60.5045 19.656 58.8485 24.912C56.4965 32.328 55.5125 37.392 55.8245 40.416C56.0885 43.08 58.5845 48.48 62.1125 50.448V57.552C55.3445 56.28 50.2085 50.352 50.2085 43.224V17.28C50.2085 9.24 56.7605 2.688 64.8005 2.688C72.8405 2.688 79.3925 9.24 79.3925 17.28V43.2Z" fill="black"/>
          <path d="M25.7286 106.68C26.7126 106.68 27.3366 106.056 27.5766 105.408H29.0166C28.6806 106.8 27.4566 108 25.7286 108C23.8326 108 22.2246 106.392 22.2246 104.304C22.2246 102.216 23.8326 100.608 25.7286 100.608C27.4086 100.608 28.6086 101.808 28.9446 103.2H27.5046C27.3366 102.576 26.6886 101.928 25.7286 101.928C24.5766 101.928 23.5926 102.912 23.5926 104.28C23.6166 105.696 24.5766 106.68 25.7286 106.68Z" fill="black"/>
          <path d="M35.5201 107.952H34.0801L36.7921 100.704H38.0641L40.7761 107.952H39.3361L38.8081 106.464H36.0481L35.5201 107.952ZM38.3521 105.168L37.4401 102.528L36.5281 105.168H38.3521Z" fill="black"/>
          <path d="M52.224 100.68V107.928H51.024L47.808 103.2V107.928H46.416V100.68H47.616L50.832 105.408V100.68H52.224Z" fill="black"/>
          <path d="M64.4877 100.68V107.928H63.2877L60.0717 103.2V107.928H58.6797V100.68H59.8797L63.0957 105.408V100.68H64.4877Z" fill="black"/>
          <path d="M71.5923 107.952H70.1523L72.8643 100.704H74.1363L76.8483 107.952H75.4083L74.8803 106.464H72.1203L71.5923 107.952ZM74.4003 105.168L73.4883 102.528L72.5763 105.168H74.4003Z" fill="black"/>
          <path d="M87.9359 105.864C87.9359 106.968 86.9519 107.928 85.5839 107.928H82.4639V100.68H85.4639C86.7359 100.68 87.6479 101.592 87.6479 102.696C87.6479 103.68 86.7839 104.088 86.7839 104.088C86.7839 104.088 87.9359 104.544 87.9359 105.864ZM83.8559 103.632H85.3439C85.8719 103.632 86.2559 103.224 86.2559 102.768C86.2559 102.312 85.8479 101.904 85.3439 101.904H83.8559V103.632ZM86.5679 105.696C86.5679 105.12 86.1119 104.664 85.4639 104.664H83.8559V106.728H85.4639C86.0879 106.728 86.5679 106.272 86.5679 105.696Z" fill="black"/>
          <path d="M95.3764 107.952H93.9844V100.704H95.3764V107.952Z" fill="black"/>
          <path d="M104.065 100.632C105.505 100.632 106.489 101.616 106.489 102.936H105.169C105.169 102.312 104.761 101.904 104.065 101.904C103.369 101.904 102.961 102.312 102.961 102.72C102.961 103.992 106.705 103.296 106.705 105.936C106.705 106.968 105.673 108 104.065 108C102.457 108 101.473 107.016 101.473 105.648H102.865C102.865 106.272 103.321 106.752 104.065 106.752C104.881 106.752 105.265 106.344 105.265 105.888C105.265 104.568 101.521 105.264 101.521 102.744C101.545 101.616 102.529 100.632 104.065 100.632Z" fill="black"/>
          <path d="M5.976 94.92H0L11.232 64.8H16.488L27.72 94.92H21.744L19.584 88.704H8.112L5.976 94.92ZM17.688 83.448L13.872 72.456L10.056 83.448H17.688Z" fill="black"/>
          <path d="M29.1845 67.68H33.9605V72.936H38.7365V77.952H33.9605V87.048C33.9605 88.968 35.1605 90.168 37.0805 90.168C38.0405 90.168 38.5205 89.928 38.5205 89.928V94.704C38.5205 94.704 37.3205 95.184 35.8805 95.184C31.5845 95.184 28.4645 92.064 28.4645 87.288V77.952H25.1045V73.416H26.5445C28.2245 73.416 29.1845 72.456 29.1845 70.776V67.68Z" fill="black"/>
          <path d="M60.9839 82.008V94.92H55.4879V82.728C55.4879 79.848 53.5679 77.952 50.9519 77.952C48.3119 77.952 46.4159 79.872 46.4159 82.728V94.92H40.9199V64.8H46.4159V75.072C46.4159 75.072 48.3359 72.672 52.6319 72.672C57.3839 72.696 60.9839 76.272 60.9839 82.008Z" fill="black"/>
          <path d="M83.5678 88.224C82.3678 91.584 78.7918 95.16 73.7518 95.16C67.7758 95.16 62.7598 90.144 62.7598 83.928C62.7598 77.712 67.7758 72.696 73.7518 72.696C79.4878 72.696 84.2638 77.232 84.2638 83.928C84.2638 84.888 84.0238 86.088 84.0238 86.088H68.7118C69.1918 88.248 70.8718 89.904 73.7278 89.904C76.6078 89.904 77.7838 88.224 77.7838 88.224H83.5678ZM68.4958 82.248H79.0078C78.5278 79.848 76.6078 77.952 73.7518 77.952C70.8958 77.952 68.9758 79.872 68.4958 82.248Z" fill="black"/>
          <path d="M106.175 82.008V94.92H100.679V82.728C100.679 79.848 98.7593 77.952 96.1433 77.952C93.5033 77.952 91.6073 79.872 91.6073 82.728V94.92H86.1113V72.912H90.1673L91.1273 75.072C91.1273 75.072 93.7673 72.672 97.3433 72.672C102.575 72.696 106.175 76.272 106.175 82.008Z" fill="black"/>
          <path d="M108.072 83.928C108.072 77.472 112.848 72.696 118.344 72.696C122.16 72.696 124.56 75.096 124.56 75.096L125.52 72.936H129.6V94.944H125.544L124.584 92.784C124.584 92.784 122.184 95.184 118.368 95.184C112.872 95.16 108.072 90.384 108.072 83.928ZM119.088 77.952C115.968 77.952 113.592 80.352 113.592 83.928C113.592 87.504 115.992 89.904 119.088 89.904C122.208 89.904 124.584 87.504 124.584 83.928C124.584 80.352 122.184 77.952 119.088 77.952Z" fill="black"/>
        </svg>
      </div>

      <div class="">

        <h1
          class="mt-5 text-2xl font-medium text-gray-900">
          Welcome to Athena Cannabis
        </h1>

        <p class="mt-5">Hi there. You must verify that you are 19 years of age or older to enter this site.</p>


        <form
          @submit.prevent="handleSubmit"
          class="mt-5">

          <h2
            class="font-medium text-lg text-gray-900">
            When were you born?
          </h2>

          <div class="mt-5 grid grid-cols-3 gap-6">
            <label for="day" class="block">
              <span class=" text-gray-700">Day</span>
              <input
                type="number"
                id="day"
                name="day"
                placeholder="DD"
                min="1"
                max="31"
                pattern="[0-9]*"
                required
                ref="dayInput"
                v-model.number="day"
                v-on:keydown="preventType"
                class="mt-1 block w-full rounded-md bg-gray-100 border-transparent
                    focus:border-gray-500 focus:bg-gray-50 focus:ring-0" />
            </label>

            <label for="month" class="block">
              <span class="text-gray-700">Month</span>
              <input
                type="number"
                id="month"
                name="month"
                placeholder="MM"
                min="1"
                max="12"
                pattern="[0-9]*"
                required
                ref="monthInput"
                v-model.number="month"
                v-on:keydown="preventType"
                class="mt-1 block w-full rounded-md bg-gray-100 border-transparent
                    focus:border-gray-500 focus:bg-gray-50 focus:ring-0" />
            </label>

            <label for="year" class="block">
              <span class="text-gray-700">Year</span>
              <input
                type="number"
                id="year"
                name="year"
                placeholder="YYYY"
                min="1899"
                max="2021"
                pattern="[0-9]*"
                required
                ref="yearInput"
                v-model.number="year"
                v-on:keydown="preventType"
                class="mt-1 block w-full rounded-md bg-gray-100 border-transparent
                    focus:border-gray-500 focus:bg-gray-50 focus:ring-0" />
            </label>

          </div>

          <div
            class="mt-5"
            v-if="Array.isArray(errors) && errors.length && !initial">
            <p class="sr-only">Form errors:</p>
            <ul>
              <li
                v-for="error in errors"
                :key="error"
                class="text-red-600 font-medium">
                {{ error }}
              </li>
            </ul>
          </div>

          <div class="my-5">
            <button
              ref="submitInput"
              type="submit"
              class="w-full bg-gray-400 text-white py-5 rounded-xl
                    text-xl font-medium
                    hover:bg-gray-600
                    focus:outline-none focus:ring-2 focus:border-black focus:bg-gray-700
                    transition-all ease-in-out duration-150"
              :class="{ 'bg-blue-800' : isAllowed , 'bg-red-400' : (!isAllowed && !initial) }">
              Verify
            </button>
          </div>

        </form>

      </div>

    </div>
  </div>
</template>

<script>
// Code inspiration from:
// https://gist.github.com/jeiemgi/bf4287e6fc4a0908e56f526945c8e1bf

import { ref, reactive, toRefs, watch } from "vue";
import { enableScrollLock , disableScrollLock } from "./../composables/scroll-lock";
import { useStore } from 'vuex';

export default {
  setup() {
    const isOpen = ref(false);

    // Use Identity Store Age Check to see if the user is allowed in
    useIdentityStoreAgeCheck();

    const {
      day,
      month,
      year,
      initial,
      errors,
      isAllowed,
      preventType,
      handleSubmit,
      dayInput,
      monthInput,
      yearInput,
      submitInput, }  = useIdentityStoreAgeCheck();


    return {
      day,
      month,
      year,
      initial,
      errors,
      isAllowed,
      preventType,
      handleSubmit,
      dayInput,
      monthInput,
      yearInput,
      submitInput,
    }
  }
}
/* Age Gate Component
 *
 * Access the vuex store to see if the user has already verified their age
 *
 * If yes - don't do anything and don't show anything on the screen
 *
 * If no - dislay the age gate UI and wait for a response from the user
 *
 *    If user inputs date check date and update the vuex store
 *
 */
function useIdentityStoreAgeCheck() {

  // Setup reactive elements
  const state = reactive({
    day: null,
    month: null,
    year: null,
    initial: true,
    errors: [],
    isAllowed: null,
  });

  // Setup ref objects
  const dayInput = ref(null);
  const monthInput = ref(null);
  const yearInput = ref(null);
  const submitInput = ref(null);

  // Obtain a reference to the vuex store
  const store = useStore();

  // Watch the Day field
  watch(
    () => state.day,
    (day, prevDay) => {
      inputFocusTransfer(day, 2, monthInput );
      adultCalculator();
    }
  )

  // Watch the Month field
  watch(
    () => state.month,
    (month, prevMonth) => {
      inputFocusTransfer(month, 2, yearInput );
      adultCalculator();
    }
  )

  // Watch the Year field
  watch(
    () => state.year,
    (year, prevDay) => {
      inputFocusTransfer(year, 4, submitInput );
      adultCalculator();
    }
  )


  // If the field is at 2 for day or month
  // and 4 for year then change the focus to the next
  // item in the form
  function inputFocusTransfer(currentNumber, targetLength, transferTarget) {

    // Putting this in a try catch as a lot can go wrong
    try {

      // Figure out the length of the number (how many digits)
      const length = Math.ceil(Math.log10(currentNumber + 1));

      if (length === targetLength)
        transferTarget.value.focus();

    }
    catch (error) {
      // Handle error
    }

  }

  function adultCalculator() {

    // If all the numbers are set then convert to a date
    if (state.day && state.month && state.year) {

      // Clear the error state
      state.errors = [];

      // Check day value - that no numbers are negative or in the right range
      if (state.day <= 0 || state.day >= 32) {
        state.errors.push("Day value is out of range");
      }

      // Check that no numbers are negative or in the right range
      if (state.month <= 0 || state.month >= 13) {
        state.errors.push("Month value is out of range");
      }

      // Check year value - that no numbers are negative or in the right range
      if (state.year < 1899) {
        state.errors.push("Year value is out of range");
      }

      if (Array.isArray(state.errors) && !state.errors.length) {

        var bday = new Date(state.year, state.month, state.day) || new Date();

        // Check that Birthday is not in the future
        if ( bday < new Date() ) {
          var timeDiff = Math.abs(new Date().getTime() - bday.getTime());
          var years = Math.ceil(timeDiff / (1000 * 3600 * 24)) / 365;
          var isAllowed = !isNaN(years) && (years >= 19);

          // Client isn't old enough than throw an error
          if (!isAllowed) {
            state.errors.push("You must be 19 years old to view this website");
          }

          state.isAllowed = isAllowed;


        }
        else {
          state.isAllowed = false;
          state.errors.push("Birthday is in the future!");
        }

      }
      else {
        state.isAllowed = false;
      }

    }

  }


  // Prevent the user from putting an
  // letters into the text boxes
  function preventType(event) {
    if (event.key === "Backspace") {
        if (event.target.value.length === 0){
            event.target.focus();
        }
    } else if (event.keyCode >= 65 && event.keyCode <= 90){
        event.preventDefault();
    }
  }


  // Submit button handler
  // Just check the isAllowed flag and then
  // call the vuex action to update the store
  // value
  function handleSubmit() {

    // Flip the initial key so that we can start showing error messages
    state.initial = false;

    // Update the is age of magority flag
    store.dispatch('identity/updateAgeOfMajority', state.isAllowed);

  }

  return {
    ...toRefs(state),
    preventType,
    handleSubmit,
    dayInput,
    monthInput,
    yearInput,
    submitInput,
  }

}
</script>
